<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
 "-//Hibernate/Hibernate Mapping DTD//EN" "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
 <hibernate-mapping>
	<sql-query name="SQL_LESSON_GET_LESSON">
		SELECT idLesson, idUser, idLanguage, title, date,text,URIname,
			(IFNULL(td.idLessonTest,0)=0 AND IFNULL(t.idLessonTest,0)>0) as testAvailable,
			IFNULL(idLessonMedia,-1) as idLessonMedia
	    FROM tlesson
	    LEFT JOIN tlessontxt USING (idLesson)
	    LEFT JOIN tlessontest t USING (idLesson)
	    LEFT JOIN tlessontestdraft td USING (idLessontest)
	    LEFT JOIN tlessonmedia USING (idLesson)		    
	    WHERE idLesson = ?
	</sql-query>
	<sql-query name="SQL_LESSON_GET_LESSONIDS_FROM_AUTHOR">
	    SELECT idLesson
	    FROM tlesson
	    JOIN tuserauthor USING(iduser)
	    WHERE tuserauthor.URIName = ?
	    ORDER BY idLesson DESC
	    LIMIT ?,11
	</sql-query>	
	<sql-query name="SQL_LESSON_GET_LESSONID_FROM_URI">
	    SELECT idLesson
	    FROM tlesson	    
	    WHERE URIname = ?
	</sql-query>
	<sql-query name="SQL_LESSON_GET_LINKEDLESSONIDS">
	    SELECT idLessonReferenced
	    FROM tlessonlinked	    
	    WHERE idLesson = ?
	    ORDER BY priority
	</sql-query>
	<sql-query name="SQL_LESSON_GET_LASTLESSONIDS">
	    SELECT idLesson
	    FROM tlesson
	    ORDER BY idLesson DESC	    
	    LIMIT ?,11
	</sql-query>
	<sql-query name="SQL_LESSON_GET_LESSONMEDIAS">
	    SELECT idMediaFile,idLessonMedia,idMediaRepository,filename,mimetype,mediaType
	    FROM tMediafile
	    JOIN tMediamimetype USING (idmediamimetype)
	    JOIN tMediatype USING (idmediatype)
	    WHERE idLessonMedia = ?	    
	</sql-query>
	<sql-query name="SQL_LESSON_CREATE_LESSON">
	    INSERT INTO tlesson(idUser, idLanguage, title, `date`, URIname)
	    VALUES (?, ?, ?, now(),?)   
	</sql-query>
	<sql-query name="SQL_LESSON_SAVE_TEXT">
	    INSERT INTO tlessontxt(idLesson,text)
	    VALUES (?,?)
	    ON DUPLICATE KEY UPDATE text = ?   
	</sql-query>	
</hibernate-mapping>