<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
 "-//Hibernate/Hibernate Mapping DTD//EN" "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
 <hibernate-mapping>
	<sql-query name="SQL_TAG_GET_LESSONIDS_FROM_TAG">
	    SELECT idLesson
	    FROM tlessontag
	    JOIN tlessononline USING(idlesson)
	    JOIN ttag USING(idTag)
	    WHERE tag = ?
	    ORDER BY idLesson DESC
	    LIMIT ?,?
	</sql-query>
	<sql-query name="SQL_TAG_GET_LESSONTAGIDS">
	    SELECT idTag
	    FROM tlessontag
	    WHERE idLesson = ?
	</sql-query>
	<sql-query name="SQL_TAG_GET_TAG">
		SELECT idTag, tag
	    FROM ttag	    	    
	    WHERE idTag = ?
	</sql-query>
	<sql-query name="SQL_TAG_GET_CLOUDTAG_TAG">
		SELECT idTag,weight FROM (
			SELECT 	idTag, COUNT(idlesson) AS weight
			FROM tlessontag
			JOIN tlessononline USING(idlesson)
			GROUP BY idtag
			ORDER BY weight DESC
			LIMIT ?
		) AS t
		JOIN ttag USING (idtag)
		ORDER BY tag;
	</sql-query>
	<sql-query name="SQL_TAG_GET_CLOUDTAG_AUTHOR">
		SELECT idUser,weight FROM (
			SELECT 	idUser, COUNT(idlesson) AS weight
			FROM tlesson
			JOIN tlessononline USING(idlesson)
			GROUP BY idUser
			ORDER BY weight DESC
			LIMIT ?
		) AS t
		JOIN tuser USING (iduser)
		ORDER BY lastname;
	</sql-query>
	<sql-query name="SQL_TAG_SAVE_LESSON_TAG">
	    INSERT IGNORE INTO tlessontag(idLesson,idTag)
	    VALUES (?,?)	       
	</sql-query>
	<sql-query name="SQL_TAG_GET_TAGID">
		SELECT idTag
	    FROM ttag	    	    
	    WHERE tag = ?
	</sql-query>	
	<sql-query name="SQL_TAG_CREATE_TAG">
	    INSERT INTO ttag(tag)
	    VALUES (?)   
	</sql-query>	
	<sql-query name="SQL_TAG_DELETE_LESSON_TAG">
	    DELETE FROM tlessontag
	    WHERE idLesson = ? AND idTag = ?
	</sql-query>
	<sql-query name="SQL_TAG_SEARCH_TAGIDS">
	    SELECT idTag
	    FROM ttag
	    WHERE tag LIKE CONCAT('%',?,'%')
	    ORDER BY tag
	    LIMIT ?,?;	       
	</sql-query>						
	<sql-query name="SQL_TAG_GET_TAGIDS">
		SELECT idTag
	    FROM ttag	
	    ORDER BY tag    	    
	    LIMIT ?,?;
	</sql-query>	
</hibernate-mapping>